---
title: Lipidomics report
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
output_file: lip
params: 
  #metadata_file: ../data/metadata.txt
  #input_file: ../data/alldata.lipidomics_summary_test_data.tsv
  input_file: D:/projects/lipidomics/example_data/Mouse-Ear-Serum/Ear_alldata.lipidomics_summary_ACSL4.tsv
  metadata_file: D:/projects/lipidomics/example_data/Mouse-Ear-Serum/metadata_ALL.tsv
  meta_sample_name: SampleName
  meta_condition_type: Type
  meta_rep: Rep
  lipid_name_col: X1
  #paired: TRUE
  paired: FALSE

---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(tidyverse)
options(knitr.duplicate.label = "allow")
source("heatmap_processing.R")
source("stats.R")
```

```{r import_data}
metadata <- readr::read_tsv(params$metadata_file)
all_data <- readr::read_tsv(params$input_file)

all_data <- dplyr::rename(
  all_data, lipid_name := tidyselect::all_of(params$lipid_name_col)
)

#all_data[1,2] <- NA

all_data <- all_data %>%
  replace(is.na(.), 0)

```

```{r process_data}
meta_info <- metadata %>%
  dplyr::rename(sample_name = tidyselect::all_of(params$meta_sample_name)) %>%
  dplyr::rename(condition = tidyselect::all_of(params$meta_condition_type)) %>%
  dplyr::mutate(condition = stringr::str_squish(condition)) #we've had double spaces that messes things up

if(params$paired) {
  meta_type <- meta_info %>%
    dplyr::rename(rep = tidyselect::all_of(params$meta_rep)) %>%
    dplyr::select(sample_name, condition, rep) %>%
    dplyr::mutate(rep = forcats::as_factor(rep))
} else {
  meta_type <- meta_info %>%
    dplyr::select(sample_name, condition)
}

tidy_data <- all_data %>%
  tidyr::pivot_longer(cols = -lipid_name, names_to = "sample_name") %>%
  replace(is.na(.), 0) %>%
  tidyr::separate(lipid_name, sep = " ", into = c("class", NA), remove = FALSE) %>%
  left_join(meta_type) %>%
  dplyr::mutate(log2_value = log2(value)) %>%
  dplyr::mutate(log2_value = if_else(log2_value == "-Inf", 0, log2_value)) # we don't want -Inf values

exp_conditions <- unique(pull(tidy_data, condition))

# this script can only cope with 2 experimental conditions, so we'll remove any extras
tidy_data <- tidy_data %>%
  filter(condition %in% exp_conditions[1:2])
exp_conditions <- exp_conditions[1:2]

```

# {.tabset .tabset-pills}

## Summary plots

### Bar plot information
The bar plots show linear mean values for each condition within each lipid subclass. They are split between low and high abundance values, where low abundance refers to lipid subclasses with value < 1 in either condition.
The errorbars show the standard error of the mean.     
   
### Forest plot information    
The plots on the right show log2 ratios between the 2 conditions, the red point shows the ratio while the lines show the confidence interval.


More information can be found in the other tabs in the report.

```{r process_bar_data}
# this needs to be done here, not in the bar_plot Rmd file, so that it is only 
# run once
dodge_width <- 0.8

bar_data_linear <- tidy_data %>%
  dplyr::group_by(class, lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(value),
    se = sd(value)/sqrt(dplyr::n())
  ) %>%
  ungroup() %>%
  group_by(lipid_name) %>%
  mutate(min_mean = min(mean)) %>%
  mutate(max_mean = max(mean)) %>%
  ungroup() %>%
 # mutate(abundance = if_else(min_mean <= 1, "low", "high"))
  mutate(abundance = if_else(max_mean <= 1, "low", "high")) %>%
  select(class, lipid_name, mean, condition, se, abundance)
```

```{r process_forest_data}
# all the data is log transformed for the forest plots
conditions <- unique(pull(tidy_data, condition))

abundance_data <- bar_data_linear %>%
  select(lipid_name, abundance) %>%
  distinct()

mean_log2 <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(log2_value), 
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = condition, values_from = mean) %>%
  mutate(ratio = .data[[conditions[1]]] - .data[[conditions[2]]])

t_test_res <- tidy_data %>%
  group_by(class, lipid_name) %>%
  select(class, lipid_name, condition, log2_value) %>%
  rstatix::t_test(log2_value ~ condition, paired = FALSE) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(padj = p.adjust(p, method="BH")) %>%
  ungroup() %>%
  mutate(tadj = qt(padj/2, df)) %>%
  left_join(mean_log2) %>%
  mutate(SE = abs(ratio/tadj), lower.limit=ratio-1.96*SE, upper.limit=ratio+1.96*SE) %>%
  left_join(abundance_data)
```
  
```{r}
# for if there are loads and we want a link to the plot further down the page
lipid_classes <- unique(tidy_data$class)
class_link <- function(class){
  paste0("<a href=", "\"", paste0("#", tolower(class)), "\">", class, "</a>")
}  
```
  
#### `r purrr::map_chr(lipid_classes, class_link)`
   
```{r, results = "asis"}
res <- lapply(lipid_classes, function(lipid_class) {
  knitr::knit_child(
    "bar_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')
```


## Summary table

```{r, eval = FALSE}
# deciding whether to log2 transform the data (by class)
stdev_ratios <- tidy_data %>%
  dplyr::group_by(class, condition) %>%
  dplyr::summarise(stdev = sd(value)) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(stdev_ratio = max(stdev)/min(stdev)) %>%
  select(class, stdev_ratio) %>%
  distinct() %>%
  deframe()

# stdev ratio check by entire dataset
tidy_data %>%
  filter(condition == exp_conditions[1]) %>%
  select(lipid_name, sample_name, value) %>%
  mutate(abundance = if_else(value <= 1, "low", "high")) %>%
  group_by(abundance) %>%
  dplyr::summarise(stdev = sd(value)) %>%
  mutate(stdev_ratio = max(stdev)/min(stdev)) 

shapiro.test(tidy_data$value)
shapiro.test(tidy_data$log2_value)

plot(density(tidy_data$value))
plot(density(tidy_data$log2_value))

removed_0 <- tidy_data %>%
  filter(value > 0)

shapiro.test(removed_0$value)
shapiro.test(removed_0$log2_value)

removed_0 %>%
  rstatix::shapiro_test(value, log2_value)

plot(density(removed_0$value))
plot(density(removed_0$log2_value))

qqnorm(removed_0$value)
qqnorm(removed_0$log2_value)


qqnorm(removed_0$value, main = "linear/raw")
qqline(removed_0$value, col = "red", lwd = 2)

qqnorm(removed_0$log2_value, main = "log2 transformed")
qqline(removed_0$log2_value, col = "red", lwd = 2)

qqnorm(log10(removed_0$value), main = "log10 transformed")
qqline(log10(removed_0$value), col = "red", lwd = 2)
```


```{r calculate_stats_individual_lipids}
# get mean and standard deviation
mean_stdev <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(value), 
    stdev = sd(value),
    se = sd(value)/sqrt(dplyr::n())
  ) %>%
  ungroup()
  
fc <- get_fold_change(mean_stdev) 

# for calculating the stats per individual lipid - functions are in stats.R 
stats_summary <- mean_stdev %>%
  group_by(lipid_name) %>%
  mutate(sd_ratio = get_sd_ratio(cur_data())) %>%
  mutate(valid_ratio = get_ratio_validity(cur_data())) %>%
  ungroup() %>%
  left_join(fc) %>%
  tidyr::separate(lipid_name, sep = " ", into = c("class", NA), remove = FALSE)

long_stats_pvals <- do_stats(tidy_data, stats_summary, params$paired) 

# multiple testing correction - by class for now.
long_stats_pvals <- long_stats_pvals %>%
  select(lipid_name, class, p_val) %>%
  distinct() %>%
  group_by(class) %>%
  mutate(adj_pval = p.adjust(p_val, method = "BH")) %>%
  ungroup() %>%
  left_join(long_stats_pvals)

stats_pvals <- long_stats_pvals %>%
  select(lipid_name, test_type, p_val, adj_pval) %>%
  distinct() %>%
  right_join(stats_summary)

```

```{r}
summary_table_data <- stats_pvals %>%
  select(-contains("ratio"), -stdev, -se) %>%
  dplyr::relocate(class) %>%
  pivot_wider(names_from = condition, names_prefix = "mean_", values_from = mean) 

log2_fc <- summary_table_data %>%
  select(starts_with("FC")) %>%
  log2() %>%
  rename_with(~ paste0("log2_", .x))

summary_table_data <- cbind(summary_table_data, log2_fc)

cols_to_round <- summary_table_data %>%
  dplyr::select(all_of(c(contains("mean"), contains("FC")))) %>%
  colnames()

pvals_to_round <- summary_table_data %>%
  dplyr::select(all_of(c(contains("p_val"), contains("pval")))) %>%
  colnames()

summary_table_data %>%
  DT::datatable(rownames = FALSE, options = list(pageLength = 15, dom = "ftlip")) %>%
  DT::formatRound(digits = 3, cols_to_round) %>%
  DT::formatRound(digits = 5, pvals_to_round)
  
```

## Metadata

<div class = "col-md-6">
```{r}
DT::datatable(meta_type, rownames = FALSE, options = list(pageLength = 15, dom = "tp"))
```
</div>


## Individual lipids

#### Scroll down to browse plots for individual lipids or click on the name in the table below to navigate directly to the plot.

```{r}
# function to create a link in this format '<a href="#pc-280">PC 28:0</a>'
get_link <- function(lipid){
  temp <- gsub(" ", "-", x = tolower(lipid))
  part1 <- paste0("#", gsub(":", "", temp))
  paste0("<a href=", "\"", part1, "\">", lipid, "</a>")
}

summary_table_data %>%
  dplyr::mutate(lipid_name = get_link(lipid_name)) %>%
  #select(-fold_change) %>%
  DT::datatable(
    rownames = FALSE, 
    options = list(pageLength = 5, dom = "tlip"), 
    filter = list(position = "top"),
    escape = FALSE) %>%
  #DT::formatRound(5:7, digits = 3)
  DT::formatRound(digits = 3, cols_to_round)
  
```

```{r, results = "asis"}
res <- lapply(unique(tidy_data$lipid_name)[1:3], function(lipid_to_plot) { # to speed up tests
#res <- lapply(unique(tidy_data$lipid_name), function(lipid_to_plot) {
  knitr::knit_child(
    "child_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')
```
  
## Totals
  
```{r}
totals <- tidy_data %>%
  group_by(class, condition) %>%
  summarise(total = sum(value)) %>%
  ungroup() %>%
  mutate(log2_total = log2(total))
```

### Linear scale

```{r}
totals %>%
  ggplot(aes(x = class, y = total, fill = condition)) + 
  geom_bar(colour = "black", 
           position= position_dodge(width = 0.8),
           width = 0.8,
           stat="identity",
           lwd = 0.8) + 
  scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, face = "bold")) +
  xlab("")
```

### Log2 scale   
  
```{r}
totals %>%
  ggplot(aes(x = class, y = log2_total, fill = condition)) + 
  geom_bar(colour = "black", 
           position= position_dodge(width = 0.8),
           width = 0.8,
           stat="identity",
           lwd = 0.8) + 
  scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, face = "bold")) +
  xlab("")
```
  
## Heatmap

```{r, heatmap_processing}
#matrix_data <- remove_0_variance(all_data)

var_above0 <- all_data %>%
  pivot_longer(-lipid_name) %>%
  group_by(lipid_name) %>%
  summarise(variance = var(value)) %>%
  filter(variance > 0) %>%
  select(lipid_name) %>%
  left_join(all_data)

heatmap_data <- tibble::column_to_rownames(var_above0, "lipid_name")
 
```  

```{r, plot_heatmap}
classes <- tidy_data %>%
  select(lipid_name, class) %>%
  distinct()

# row names with their class
df_lipids <- var_above0 %>%
  select(lipid_name) %>%
  left_join(classes) 

row_annotation <- tibble::column_to_rownames(df_lipids, "lipid_name")

col_annotation <- enframe(colnames(heatmap_data), name = NULL, value = "sample_name") %>%
  left_join(meta_type) %>%
  tibble::column_to_rownames("sample_name")

# Lipid classes need further sorting to create custom row annotations where only
# the class name is displayed rather than each individual lipid.
lipid_summary <- get_lipid_summary(df_lipids)
lipid_labels <- create_lipid_class_labels(lipid_summary, nrow(df_lipids))
lipid_colours <- create_lipid_colours(
  class_names = dplyr::pull(lipid_summary, class)
)
group_colours <- stats::setNames(c("blue", "green"), exp_conditions)

annot_colours <- list(
  value = group_colours,
  class = lipid_colours
)
```

### Heatmap ordered by lipid subclass

```{r, fig.height = 8, fig.width = 10}
pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  cluster_rows = FALSE,
  labels_row = lipid_labels,
  fontsize_row = 8,
  annotation_colors = annot_colours#,
  #annotation_legend = FALSE
)
```

<br>
<br>

### With row clustering

```{r, fig.height = 8, fig.width = 10}
pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  annotation_colors = annot_colours
)
```
