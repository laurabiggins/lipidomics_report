---
title: Lipidomics report
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: false
output_file: lip
params: 
  #metadata_file: ../data/metadata.txt
  #input_file: ../data/alldata.lipidomics_summary_test_data.tsv
  input_file: D:/projects/lipidomics/example_data/CSC/datasets/alldata.lipidomics_summary_MiaPaca2_Parental-CSC.csv
  metadata_file: D:/projects/lipidomics/example_data/CSC/metadata_4_reps.txt
  #meta_info: NULL 
  meta_sample_name: SampleName
  meta_condition_type: Type
  meta_rep: Rep
  lipid_name_col: X1
  #paired: TRUE
  paired: FALSE
  quick_test: TRUE
  output_folder: out
  bar_class_ylabel: value
  #control: Control
  control: Parental
  #interactive: TRUE

---

<p style="font-size: 11px";>
This report aims to present lipid data in relation to the different conditions with which they are associated. It is not a definitive analysis of the data but rather an introduction to it.  
Lipid data tends to be log-normal so, prior to statistical analyses, the data were log transformed to meet the assumptions of the tests. However, such transformation may not be suitable for all classes/species so the p-values should always be interpreted after careful graphical exploration of the data.
</p>

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = FALSE)
library(ggplot2)
library(tidyverse)
options(knitr.duplicate.label = "allow")
source("heatmap_processing.R")
source("stats.R")
source("utils.R")
```

```{r import_data, include=FALSE}
all_data <- switch(tools::file_ext(params$input_file), 
       tsv = ,
       txt = readr::read_tsv(params$input_file),
       csv = readr::read_csv(params$input_file),
       stop("Unknown file extension on data file")
)

meta_info <- process_metadata(metadata_file = params$metadata_file, control = params$control)
```

```{r checks, include = FALSE}
# sanity checks on data needed
assertthat::assert_that(
  params$lipid_name_col %in% colnames(all_data), 
  msg = paste0(
    "params$lipid_name_col ", 
    params$lipid_name_col, 
    " not found in ", 
    colnames(all_data)
  )
)

assertthat::assert_that(
  all(colnames(all_data) %in% c(meta_info$sample_name, params$lipid_name_col)),
  msg = paste0("Unexpected column name found in all_data file")
)
```

```{r process_data, include = FALSE}
all_data <- dplyr::rename(
  all_data, lipid_name := tidyselect::all_of(params$lipid_name_col)
)

all_data <- all_data %>%
  replace(is.na(.), 0)

if(params$paired) {
  meta_type <- meta_info %>%
    dplyr::rename(rep = tidyselect::all_of(params$meta_rep)) %>%
    dplyr::select(sample_name, condition, rep) %>%
    dplyr::mutate(rep = forcats::as_factor(rep))
} else {
  meta_type <- meta_info %>%
    dplyr::select(sample_name, condition)
}

tidy_data <- all_data %>%
  tidyr::pivot_longer(cols = -lipid_name, names_to = "sample_name") %>%
  replace(is.na(.), 0) %>%
  tidyr::separate(lipid_name, sep = " ", into = c("class", NA), remove = FALSE) %>%
  left_join(meta_type) %>%
  dplyr::mutate(log2_value = log2(value)) %>%
  dplyr::mutate(log2_value = if_else(log2_value == "-Inf", 0, log2_value)) # we don't want -Inf values

exp_conditions <- unique(pull(tidy_data, condition))
exp_conditions <- exp_conditions[1:2] # this script can only deal with 2 conditions
exp_conditions <- c(exp_conditions[exp_conditions != params$control], params$control)
assertthat::assert_that(length(exp_conditions) == 2, msg = "Number of experimental conditions doesn't equal 2")

meta_type <- meta_type %>%
  filter(condition %in% exp_conditions)

tidy_data <- tidy_data %>%
  filter(condition %in% exp_conditions)

```

```{r process_bar_data}
# this needs to be done here, not in the bar_plot Rmd file, so that it is only 
# run once
dodge_width <- 0.8

bar_data_linear_median <- tidy_data %>%
  dplyr::group_by(class, lipid_name, condition) %>%
  dplyr::summarise(median = median(value)) %>%
  ungroup() %>%
  group_by(lipid_name) %>%
  mutate(min_median = min(median)) %>%
  mutate(max_median = max(median)) %>%
  ungroup() %>%
  mutate(abundance = if_else(max_median <= 1, "low", "high")) %>%
  left_join(tidy_data) %>%
  select(class, lipid_name, value, median, condition, abundance) 
  
```

```{r calculate_stats_individual_lipids}
# for calculating the stats per individual lipid - functions are in stats.R 
long_stats_pvals <- do_stats(tidy_data, params$paired)

# multiple testing correction - by class for now.
long_stats_pvals <- long_stats_pvals %>%
  select(lipid_name, class, p_val) %>%
  distinct() %>%
  drop_na() %>% # so we're not overcorrecting
  group_by(class) %>%
  mutate(adj_pval = p.adjust(p_val, method = "BH")) %>%
  ungroup() %>%
  right_join(long_stats_pvals)

fc <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(log2_mean = mean(log2_value)) %>%
  ungroup() %>%
  pivot_wider(names_from = condition, names_prefix = "log2_mean_", values_from = log2_mean) %>%
  mutate(log2_fc = .data[[paste0("log2_mean_", exp_conditions[1])]] - .data[[paste0("log2_mean_", exp_conditions[2])]])


stats_pvals <- long_stats_pvals %>%
  select(class, lipid_name, test_type, p_val, adj_pval) %>%
  distinct() %>%
  right_join(fc)

summary_table_data <- stats_pvals %>%
  select(-p_val)

cols_to_round <- summary_table_data %>%
  dplyr::select(all_of(c(contains("mean"), contains("FC")))) %>%
  colnames()
pvals_to_round <- summary_table_data %>%
  dplyr::select(all_of(c(contains("pval")))) %>%
  colnames()

two_sample_t_test_lipids <- stats_pvals %>%
  filter(test_type %in% c("independent_t_test", "paired_t_test")) %>%
  select(lipid_name) %>%
  distinct() %>%
  pull()
```


```{r process_forest_data}
# all the data is log transformed for the forest plots
conditions <- unique(pull(tidy_data, condition))

abundance_data <- bar_data_linear_median %>%
  select(lipid_name, abundance) %>%
  distinct()

mean_log2 <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(log2_value), 
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = condition, values_from = mean) %>%
  mutate(ratio = .data[[exp_conditions[1]]] - .data[[exp_conditions[2]]])

# the p-values should match those in the summary table/individual lipids. It's easier doing the stats separately
# here as we need some of the t-statistic values for the forest plot. Then afterwards, we filter for the lipids
# that met test assumptions. The multiple testing correction is probably a bit harsh though - we're currently
# including the lipids with "none" tests. 
# 
t_test_res <- tidy_data %>%
  group_by(class, lipid_name) %>%
  select(class, lipid_name, condition, log2_value) %>%
  rstatix::t_test(log2_value ~ condition, paired = params$paired) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(padj = p.adjust(p, method="BH")) %>%
  ungroup() %>%
  mutate(tadj = qt(padj/2, df)) %>%
  left_join(mean_log2) %>%
  mutate(SE = abs(ratio/tadj), lower.limit=ratio-1.96*SE, upper.limit=ratio+1.96*SE) %>%
  left_join(abundance_data) %>%
  filter(lipid_name %in% two_sample_t_test_lipids) 
```

# {.tabset .tabset-pills}

## 1. Summary

```{r, child='summary_plots.Rmd'}
```


## 2. Class plots

### Bar plot information
The bar plots show linear median values for each condition within each lipid subclass. They are split between low and high abundance values, where low abundance refers to lipid subclasses with a median 
value < 1 in either condition.
The points show each individual value.
   
### Forest plot information    
The plots on the right show log2 ratios between the 2 conditions, the red point 
shows the ratio while the lines show the confidence interval. If the confidence 
interval does not span over 0, the difference between the 2 conditions for that 
particular species will be significant.  
Subclasses that did not fit the assumptions for t_tests may not be shown in these plots.
  

```{r}
# for if there are loads and we want a link to the plot further down the page
lipid_classes <- unique(tidy_data$class)
class_link <- function(class){
  paste0("<a href=", "\"", paste0("#", tolower(class)), "\">", class, "</a>")
}  
```
  
#### `r purrr::map_chr(lipid_classes, class_link)`
   
```{r, results = "asis"}
res <- lapply(lipid_classes, function(lipid_class) {
  knitr::knit_child(
    "bar_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')
```

## 3. Individual lipids

#### Scroll down to browse plots for individual lipids or click on the name in the table below to navigate directly to the plot.

```{r}
# function to create a link in this format '<a href="#pc-280">PC 28:0</a>'
get_link <- function(lipid){
  temp <- gsub(" ", "-", x = tolower(lipid))
  part1 <- paste0("#", gsub(":", "", temp))
  paste0("<a href=", "\"", part1, "\">", lipid, "</a>")
}

summary_table_data %>%
  dplyr::mutate(lipid_name = get_link(lipid_name)) %>%
  DT::datatable(
    rownames = FALSE, 
    options = list(pageLength = 10, dom = "tlip"), 
    filter = list(position = "top"),
    escape = FALSE
    ) %>%
  DT::formatRound(digits = 3, cols_to_round) %>%
  DT::formatRound(digits = 5, pvals_to_round)

```

```{r}
out_file <- paste0(params$output_folder, "/data_table.csv") 
readr::write_csv(stats_pvals, file = out_file) 
```

```{r, results = "asis"}
lipids_for_plotting <- unique(tidy_data$lipid_name)
  
if(params$quick_test) lipids_for_plotting <- lipids_for_plotting[1:3]

res <- lapply(lipids_for_plotting, function(lipid_to_plot) {
  knitr::knit_child(
    "child_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')

```
  
## 4. Experimental info

<div class = "row">
<div class = "col-md-6">
```{r}
DT::datatable(meta_type, rownames = FALSE, options = list(pageLength = 15, dom = "tp"))
```
</div>
</div>
<br>
   
### QQ plots of all data  
  
0 values have been removed.  

```{r, out.width=c('50%', '50%'), fig.show='hold', fig.height = 6}
removed_0 <- tidy_data %>%
  filter(value > 0)

qqnorm(removed_0$value, main = "linear/raw")
qqline(removed_0$value, col = "red", lwd = 2)

qqnorm(removed_0$log2_value, main = "log2 transformed")
qqline(removed_0$log2_value, col = "red", lwd = 2)
```
