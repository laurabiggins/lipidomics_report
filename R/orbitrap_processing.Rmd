---
title: Lipidomics report
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
output_file: lip
params: 
  metadata_file: ../data/metadata.txt
  input_file: ../data/alldata.lipidomics_summary_test_data.tsv
  #input_file: x
  meta_sample_name: SampleName
  meta_condition_type: Type
  meta_rep: Rep
  lipid_name_col: X1
  paired: TRUE

---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(tidyverse)
options(knitr.duplicate.label = "allow")
source("heatmap_processing.R")
source("stats.R")

# Need to sort out an extra field in the metadata for paired samples, a rep column
```

```{r import_data}
metadata <- readr::read_tsv(params$metadata_file)
all_data <- readr::read_tsv(params$input_file)

all_data <- dplyr::rename(all_data, lipid_name := tidyselect::all_of(params$lipid_name_col))
```

```{r process_data}
meta_info <- metadata %>%
  dplyr::rename(sample_name = tidyselect::all_of(params$meta_sample_name)) %>%
  dplyr::rename(condition = tidyselect::all_of(params$meta_condition_type)) %>%
  dplyr::mutate(condition = stringr::str_squish(condition)) #we've had double spaces that messes things up

if(params$paired) {
  meta_type <- meta_info %>%
    dplyr::rename(rep = tidyselect::all_of(params$meta_rep)) %>%
    dplyr::select(sample_name, condition, rep) %>%
    dplyr::mutate(rep = forcats::as_factor(rep))
} else {
  meta_type <- meta_info %>%
    dplyr::select(sample_name, condition)
}

tidy_data <- all_data %>%
  tidyr::pivot_longer(cols = -lipid_name, names_to = "sample_name") %>%
  tidyr::separate(lipid_name, sep = " ", into = c("class", NA), remove = FALSE) %>%
  left_join(meta_type) %>%
  dplyr::mutate(log2_value = log2(value)) %>%
  dplyr::mutate(log2_value = if_else(log2_value == "-Inf", 0, log2_value)) # we don't want -Inf values

exp_conditions <- unique(pull(tidy_data, condition))
```


```{r calculate_some_stats}
# get mean and standard deviation
mean_stdev <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(value), 
    stdev = sd(value),
    se = sd(value)/sqrt(dplyr::n())
  ) %>%
  ungroup()
  
fc <- get_fold_change(mean_stdev) 

stats_summary <- mean_stdev %>%
  group_by(lipid_name) %>%
  mutate(sd_ratio = get_sd_ratio(cur_data())) %>%
  mutate(valid_ratio = get_ratio_validity(cur_data())) %>%
  ungroup() %>%
  left_join(fc) %>%
  tidyr::separate(lipid_name, sep = " ", into = c("class", NA), remove = FALSE)

long_stats_pvals <- do_stats(tidy_data, stats_summary, params$paired) 

stats_pvals <- long_stats_pvals %>%
  select(lipid_name, test_type, p_val) %>%
  distinct() %>%
  right_join(stats_summary)

```

```{r log_stats}
# to remove eventually but it is used for the bar plots at the moment

log_stats <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(log2_value), 
    stdev = sd(log2_value),
    se = sd(log2_value)/sqrt(dplyr::n())
  ) %>%
  ungroup()

# get mean fold change
log_data <- log_stats %>%
  pivot_wider(id_cols = c(lipid_name, condition, mean), names_from = condition, values_from = mean) %>%
  mutate(log2_FC = .data[[exp_conditions[1]]] - .data[[exp_conditions[2]]]) %>%
  select(lipid_name, log2_FC) %>%
  left_join(log_stats) %>%
  tidyr::separate(lipid_name, sep = " ", into = c("class", NA), remove = FALSE) 
```

```{r ratio_stats}
conditions <- unique(tidy_data$condition)

x <- tidy_data %>%
  group_by(class, lipid_name, condition) %>% 
  summarise(
    sum = sum(value),
    mean = mean(value), 
    stdev = sd(value),
    se = sd(value)/sqrt(dplyr::n())
  ) %>%
  ungroup() 

ratios <- x %>%
  group_by(lipid_name) %>%
  pivot_wider(id_cols = c(lipid_name, condition, sum), 
    names_from = condition, 
    values_from = sum,
  ) %>%
  mutate(ratio = .data[[conditions[1]]]/.data[[conditions[2]]]) %>%
  select(lipid_name, ratio) %>%
  right_join(x) %>%
  group_by(lipid_name) %>%
  slice(1)
```


# {.tabset .tabset-pills}

## Summary plots

### Bar plots for lipid classes
These plots show log2 transformed mean values for each condition 
within each lipid subclass. The errorbars show the standard error of the mean.  
More information can be found in the other tabs in the report.
  

```{r}
# for if there are loads and we want a link to the plot further down the page
lipid_classes <- unique(tidy_data$class)
class_link <- function(class){
  paste0("<a href=", "\"", paste0("#", tolower(class)), "\">", class, "</a>")
}  
```

#### `r sapply(lipid_classes, class_link)`

```{r}
# so we don't have negative values on the barplot
# add <- if_else(min(log_data$mean) < 0, abs(min(log_data$mean)), 0)
# bar_data <- mutate(log_data, inflated_mean = mean + add)
dodge_width <- 0.8

bar_data <- log_data %>%
  group_by(lipid_name) %>%
  mutate(min_mean = min(mean)) %>%
  ungroup() %>%
  mutate(abundance = if_else(min_mean <= 0, "low", "high"))

bar_data_linear <- bar_data %>% 
  select(lipid_name, abundance) %>%
  distinct() %>%
  left_join(stats_pvals)

ratio_data <- bar_data %>% 
  select(lipid_name, abundance) %>%
  distinct() %>%
  left_join(ratios)

```

```{r, results = "asis"}
res <- lapply(lipid_classes, function(lipid_class) {
  knitr::knit_child(
    "bar_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')
```


## Summary table

```{r}
summary_table_data <- stats_pvals %>%
  select(-contains("ratio"), -stdev, -se) %>%
  dplyr::relocate(class) %>%
  pivot_wider(names_from = condition, names_prefix = "mean_", values_from = mean) 

log2_fc <- summary_table_data %>%
  select(starts_with("FC")) %>%
  log2() %>%
  rename_with(~ paste0("log2_", .x))

summary_table_data <- cbind(summary_table_data, log2_fc)

cols_to_round <- summary_table_data %>%
  dplyr::select(all_of(c(contains("mean"), contains("FC")))) %>%
  colnames()

summary_table_data %>%
  DT::datatable(rownames = FALSE, options = list(pageLength = 15, dom = "ftlip")) %>%
  DT::formatRound(digits = 3, cols_to_round)

```

## Metadata

<div class = "col-md-6">
```{r}
DT::datatable(meta_type, rownames = FALSE, options = list(pageLength = 15, dom = "tp"))
```
</div>


## Individual lipids

#### Scroll down to browse plots for individual lipids or click on the name in the table below to navigate directly to the plot.

```{r}
# function to create a link in this format '<a href="#pc-280">PC 28:0</a>'
get_link <- function(lipid){
  temp <- gsub(" ", "-", x = tolower(lipid))
  part1 <- paste0("#", gsub(":", "", temp))
  paste0("<a href=", "\"", part1, "\">", lipid, "</a>")
}

summary_table_data %>%
  dplyr::mutate(lipid_name = get_link(lipid_name)) %>%
  #select(-fold_change) %>%
  DT::datatable(
    rownames = FALSE, 
    options = list(pageLength = 5, dom = "tlip"), 
    filter = list(position = "top"),
    escape = FALSE) %>%
  #DT::formatRound(5:7, digits = 3)
  DT::formatRound(digits = 3, cols_to_round)
  
```

```{r, results = "asis"}
#res <- lapply(unique(tidy_data$lipid_name)[1:3], function(lipid_to_plot) { # to speed up tests
res <- lapply(unique(tidy_data$lipid_name), function(lipid_to_plot) {
  knitr::knit_child(
    "child_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')
```


## Heatmap

```{r, heatmap_processing}
#matrix_data <- remove_0_variance(all_data)

var_above0 <- all_data %>%
  pivot_longer(-lipid_name) %>%
  group_by(lipid_name) %>%
  summarise(variance = var(value)) %>%
  filter(variance > 0) %>%
  select(lipid_name) %>%
  left_join(all_data)

heatmap_data <- tibble::column_to_rownames(var_above0, "lipid_name")
 
```  

```{r, plot_heatmap}
classes <- tidy_data %>%
  select(lipid_name, class) %>%
  distinct()

# row names with their class
df_lipids <- var_above0 %>%
  select(lipid_name) %>%
  left_join(classes) 

row_annotation <- tibble::column_to_rownames(df_lipids, "lipid_name")

col_annotation <- enframe(colnames(heatmap_data), name = NULL, value = "sample_name") %>%
  left_join(meta_type) %>%
  tibble::column_to_rownames("sample_name")

# Lipid classes need further sorting to create custom row annotations where only
# the class name is displayed rather than each individual lipid.
lipid_summary <- get_lipid_summary(df_lipids)
lipid_labels <- create_lipid_class_labels(lipid_summary, nrow(df_lipids))
lipid_colours <- create_lipid_colours(
  class_names = dplyr::pull(lipid_summary, class)
)
group_colours <- stats::setNames(c("blue", "green"), exp_conditions)

annot_colours <- list(
  value = group_colours,
  class = lipid_colours
)
```
### Heatmap ordered by lipid subclass

```{r, fig.height = 8, fig.width = 10}
pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  cluster_rows = FALSE,
  labels_row = lipid_labels,
  fontsize_row = 8,
  annotation_colors = annot_colours#,
  #annotation_legend = FALSE
)
```

<br>
<br>

### With row clustering

```{r, fig.height = 8, fig.width = 10}
pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  annotation_colors = annot_colours
)
```


## Test

```{r}
#knitr::knit_child("forest_plots.Rmd", envir = environment(), quiet = TRUE)
```

```{r, results = "asis"}
lipid_classes <- unique(tidy_data$class)
res <- lapply(lipid_classes, function(lipid_class) {
  knitr::knit_child(
    "forest_plots.Rmd", envir = environment(), quiet = TRUE
  )
})
cat(unlist(res), sep = '\n')
```



