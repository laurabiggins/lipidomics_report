### `r lipid_class`  
  
<br>

```{r barplot_function}

custom_barplot <- function(bar_data, lipid_class, abundance_level){

  bar_data %>%
    filter(class == lipid_class) %>%
    filter(abundance == abundance_level) %>%
    ggplot(aes(x = lipid_name, y = mean, fill = condition)) + 
    geom_bar(colour = "black", 
             position= position_dodge(width = dodge_width),
             width = 0.8,
             stat="identity",
             lwd = 0.8) + 
    geom_errorbar(
      aes(ymin=mean-se, ymax=mean+se), 
      position = position_dodge(width = dodge_width), 
      width = 0.25,
      lwd = 0.8
    ) +
    scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, face = "bold")) +
    xlab("")
}

```

```{r forest_function}

custom_forest <- function(plot_data, lipid_class, abundance_level){

  plot_data %>%
    filter(class == lipid_class) %>%
    filter(abundance == abundance_level) %>%
    ggplot(aes(ratio, lipid_name)) +
    geom_errorbar(aes(xmin=lower.limit, xmax=upper.limit), width = 0.5, lwd=0.8, show.legend=FALSE)+
    geom_point(size=3, colour="darkred")+
    geom_vline(xintercept=0, linetype="dashed", color = "red")+
    scale_x_continuous(breaks=seq(from =-15, by=1, to=5))
}  
```


```{r process_bar_data}
dodge_width <- 0.8

bar_data_linear <- tidy_data %>%
  dplyr::group_by(class, lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(value),
    se = sd(value)/sqrt(dplyr::n())
  ) %>%
  ungroup() %>%
  group_by(lipid_name) %>%
  mutate(min_mean = min(mean)) %>%
  mutate(max_mean = max(mean)) %>%
  ungroup() %>%
 # mutate(abundance = if_else(min_mean <= 1, "low", "high"))
  mutate(abundance = if_else(max_mean <= 1, "low", "high")) %>%
  select(class, lipid_name, mean, condition, se, abundance)
```

```{r process_forest_data}
conditions <- unique(pull(tidy_data, condition))

abundance_data <- bar_data_linear %>%
  select(lipid_name, abundance) %>%
  distinct()

mean_log2 <- tidy_data %>%
  dplyr::group_by(lipid_name, condition) %>%
  dplyr::summarise(
    mean = mean(log2_value), 
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = condition, values_from = mean) %>%
  mutate(ratio = .data[[conditions[1]]] - .data[[conditions[2]]])

t_test_res <- tidy_data %>%
  group_by(class, lipid_name) %>%
  select(class, lipid_name, rep, condition, log2_value) %>%
  rstatix::t_test(log2_value ~ condition, paired = FALSE) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(padj = p.adjust(p, method="BH")) %>%
  ungroup() %>%
  mutate(tadj = qt(padj/2, df)) %>%
  left_join(mean_log2) %>%
  mutate(SE = abs(ratio/tadj), lower.limit=ratio-1.96*SE, upper.limit=ratio+1.96*SE) %>%
  left_join(abundance_data)
```

#### High abundance

```{r, out.width=c('50%', '50%'), fig.show='hold', fig.height = 6}

custom_barplot(bar_data_linear, lipid_class, abundance_level = "high")
custom_forest(t_test_res, lipid_class, abundance_level = "high")
```

<br>  

#### Low abundance

```{r, out.width=c('50%', '50%'), fig.show='hold', fig.height = 6}

custom_barplot(bar_data_linear, lipid_class, abundance_level = "low")
custom_forest(t_test_res, lipid_class, abundance_level = "low")
```

<br> 
    
```{r, eval = FALSE}
# this looks a bit rubbish as there's not much data in it
t_test_res %>%
  ggplot(aes(x = ratio, y = -log10(padj)))+
  geom_point()
```

<br>

