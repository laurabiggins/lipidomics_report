```{r}
# requires the all_data df
```

```{r}
totals <- tidy_data %>%
  group_by(class, condition) %>%
  summarise(total = sum(value)) %>%
  ungroup() %>%
  mutate(log2_total = log2(total)) %>%
  group_by(condition) %>%
  mutate(percent = (total/sum(total))*100) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(max_percent = max(percent)) %>%
  ungroup() %>%
  mutate(pie_class = if_else(max_percent > 1, class, "other"))


bar_totals_linear <- tidy_data %>%
  group_by(class, condition, sample_name) %>%
  dplyr::summarise(total = sum(value)) %>%
  ungroup() %>%
  group_by(class, condition) %>%
  dplyr::summarise(
    mean_total = mean(total),
    se_total = sd(total)/sqrt(dplyr::n())
  ) %>%
  ungroup()

bar_totals_log2 <- tidy_data %>%
  group_by(class, condition, sample_name) %>%
  dplyr::summarise(total = sum(log2_value)) %>%
  ungroup() %>%
  group_by(class, condition) %>%
  dplyr::summarise(
    mean_total = mean(total),
    se_total = sd(total)/sqrt(dplyr::n())
  ) %>%
  ungroup()

```

<hr class="style2">  

### Summary of total amounts across all samples

The pie charts show the proportion of lipid types in the samples. Any that comprised
< 1% of the total amount were grouped into an "other" category for the pie charts.
The full set and values can be found in the table below.  
The plots and table show total summed values across all replicates.

```{r, out.width=c('50%', '50%'), fig.show='hold', fig.height = 7}
pie_data <- totals %>%
  select(pie_class, percent, condition) %>%
  group_by(pie_class, condition) %>%
  summarise(total_pie_percent = sum(percent)) %>%
  ungroup()

pie_cond1 <- pie_data %>%
  filter(condition == exp_conditions[1])

pie_cond2 <- pie_data %>%
  filter(condition == exp_conditions[2])

n_col <- nrow(pie_cond1)

pie(
  pie_cond1$total_pie_percent, 
  labels=pie_cond1$pie_class, 
  col=rainbow(n_col),
  main = exp_conditions[1]
)
pie(
  pie_cond2$total_pie_percent, 
  labels=pie_cond2$pie_class, 
  col=rainbow(n_col),
  main = exp_conditions[2]
  )
```

```{r}
totals %>%
  dplyr::arrange(desc(max_percent)) %>%
  select(class, condition, total, percent) %>%
  tidyr::pivot_wider(names_from = condition, values_from = c(total, percent)) %>%
  DT::datatable(
      rownames = FALSE, 
      options = list(pageLength = 15, dom = "tlip"), 
     # filter = list(position = "top"),
      escape = FALSE
      ) %>%
    DT::formatRound(digits = 2, 2:5) 
```

<br><br>
<hr>
<br><br>

### Mean of total amounts 
```{r}
bar_totals_linear %>%
  dplyr::arrange(desc(mean_total)) %>%
  select(class, condition, mean_total) %>%
  tidyr::pivot_wider(names_from = condition, values_from = c(mean_total)) %>%
  DT::datatable(
      rownames = FALSE, 
      options = list(pageLength = 15, dom = "tlip"), 
      escape = FALSE
      ) %>%
    DT::formatRound(digits = 2, 2:3) 
```

<br><br>

### Mean of total amounts - linear scale

```{r}
bar_totals_linear %>%
  dplyr::arrange(desc(mean_total)) %>%
  ggplot(aes(x = class, y = mean_total, fill = condition)) + 
  geom_bar(
    colour = "black", 
    position= position_dodge(width = 0.8),
    width = 0.8,
    stat="identity",
    lwd = 0.8
  ) + 
  geom_errorbar(
      aes(ymin=mean_total-se_total, ymax=mean_total+se_total), 
      position = position_dodge(width = dodge_width), 
      width = 0.25,
      lwd = 0.8
    ) +
  scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, face = "bold")) +
  xlab("")

# totals %>%
#   ggplot(aes(x = class, y = total, fill = condition)) + 
#   geom_bar(
#     colour = "black", 
#     position= position_dodge(width = 0.8),
#     width = 0.8,
#     stat="identity",
#     lwd = 0.8
#   ) + 
#   scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, face = "bold")) +
#   xlab("")
```

### Totals - log2 scale   
  
```{r}
bar_totals_linear %>%
  ggplot(aes(x = class, y = log2(mean_total), fill = condition)) + 
  geom_bar(
    colour = "black", 
    position= position_dodge(width = 0.8),
    width = 0.8,
    stat="identity",
    lwd = 0.8
  ) + 
  # geom_errorbar(
  #     aes(ymin=log2(mean_total)-log2(se_total), ymax=log2(mean_total)+log2(se_total)), 
  #     position = position_dodge(width = dodge_width), 
  #     width = 0.25,
  #     lwd = 0.8
  #   ) +
  scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, face = "bold")) +
  xlab("")

# totals %>%
#   ggplot(aes(x = class, y = log2_total, fill = condition)) + 
#   geom_bar(
#     colour = "black", 
#     position= position_dodge(width = 0.8),
#     width = 0.8,
#     stat="identity",
#     lwd = 0.8
#   ) + 
#   scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, face = "bold")) +
#   xlab("")
```

```{r, results="asis"}
# doesn't work properly using headers as it messes up the tabs
large_text <- function(x, size = 16) {
  sprintf("<span style='font-size: %spx;'>%s</span>", size, x)
}
```

```{r, heatmap_processing}
var_above0 <- all_data %>%
  pivot_longer(-lipid_name) %>%
  group_by(lipid_name) %>%
  summarise(variance = var(value)) %>%
  filter(variance > 0) %>%
  select(lipid_name) %>%
  left_join(all_data)

heatmap_data <- tibble::column_to_rownames(var_above0, "lipid_name")
```  

```{r, plot_heatmap}
classes <- tidy_data %>%
  select(lipid_name, class) %>%
  distinct()

# row names with their class
df_lipids <- var_above0 %>%
  select(lipid_name) %>%
  left_join(classes) 

row_annotation <- tibble::column_to_rownames(df_lipids, "lipid_name")

col_annotation <- enframe(colnames(heatmap_data), name = NULL, value = "sample_name") %>%
  left_join(meta_type) %>%
  tibble::column_to_rownames("sample_name")

# Lipid classes need further sorting to create custom row annotations where only
# the class name is displayed rather than each individual lipid.
lipid_summary <- get_lipid_summary(df_lipids)
lipid_labels <- create_lipid_class_labels(lipid_summary, nrow(df_lipids))
lipid_colours <- create_lipid_colours(
  class_names = dplyr::pull(lipid_summary, class)
)
group_colours <- stats::setNames(c("blue", "darkgreen"), exp_conditions)

annot_colours <- list(
  condition = group_colours,
  class = lipid_colours
)
```

<br>
<br>
<hr class="style2">  
<br>
<br>  
  
###  Volcano plot

```{r}
phospholipids <- c('PA', 'PC', 'PE', 'PG', 'PI', 'PS', 'CL')
lysolipids <- c('LPA', 'LPC', 'LPE', 'LPG', 'LPI', 'LPS')
sphingolipids <- c('SG', 'SM', 'dhSM', 'dhCer', 'Cer')
neutral_lipids <- c("TG", "DA")

superclasses <- tibble::enframe(
  c(
    setNames(phospholipids, rep("phospholipids", length(phospholipids))),
    setNames(lysolipids, rep("lysolipids", length(lysolipids))),
    setNames(sphingolipids, rep("sphingolipids", length(sphingolipids))),
    setNames(neutral_lipids, rep("neutral_lipids", length(neutral_lipids)))
  ), name = "superclass", value = "class"
)
```

<div class = "row">
<div class = "col-md-4">
<br><br><br><br>
The y axis values are transformed p values from t-tests between `r exp_conditions[1]` 
and `r exp_conditions[2]` for each lipid.
The x axis shows the magnitude of difference between the conditions for that lipid.

Each point on the plot is a lipid (subclass?).   
Hover over a point to see the name.

The dashed red line shows significance i.e. any points above this are likely to 
be significantly different between the 2 conditions. 

</div>
<div class = "col-md-8">
```{r, fig.height=5, fig.width=6}
p <- t_test_res %>%
  left_join(superclasses) %>%
  ggplot(aes(x = ratio, y = -log10(padj), col = superclass, annotation = lipid_name)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = "red", linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed", col = "grey") +
  theme(legend.title = element_blank())

plotly::ggplotly(p, tooltip = "lipid_name")
```
</div>
</div>

<br>
<br>
<hr class="style2">  
<br>
<br>

### Heatmaps

#### Rows ordered by lipid subclass, columns ordered by condition, no clustering

```{r, fig.height = 8, fig.width = 10}
pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  labels_row = lipid_labels,
  fontsize_row = 8,
  annotation_colors = annot_colours#,
  #annotation_legend = FALSE
)
```

<br>
<br>

#### Rows ordered by lipid subclass, clustered by columns

```{r, fig.height = 8, fig.width = 10}
pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  cluster_rows = FALSE,
  labels_row = lipid_labels,
  fontsize_row = 8,
  annotation_colors = annot_colours#,
  #annotation_legend = FALSE
)
```

<br>
<br>

#### With row clustering and column clustering

```{r, fig.height = 8, fig.width = 10}
too_many_names <- if_else(nrow(heatmap_data) > 70, FALSE, TRUE)

pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  annotation_colors = annot_colours, 
  show_rownames = too_many_names
)
```

