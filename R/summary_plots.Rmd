
```{r}
#!! sort this out - we don't need 2 totals tables
totals <- tidy_data %>%
  group_by(class, condition) %>%
  summarise(total = sum(value)) %>%
  ungroup() %>%
  mutate(log2_total = log2(total)) %>%
  group_by(condition) %>%
  mutate(percent = (total/sum(total))*100) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(max_percent = max(percent)) %>%
  ungroup() %>%
  mutate(pie_class = if_else(max_percent > 1, class, "other"))

total_of_means <- tidy_data %>%
  group_by(class, condition, sample_name) %>%
  summarise(total = sum(value)) %>%
  ungroup() %>%
  group_by(class, condition) %>%
  dplyr::summarise(
    mean_total = mean(total),
    se_total = sd(total)/sqrt(dplyr::n())
  ) %>%
  ungroup() %>%
  group_by(condition) %>%
  mutate(percent = (mean_total/sum(mean_total))*100) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(max_percent = max(percent)) %>%
  mutate(max_mean_total = max(mean_total)) %>%
  ungroup() %>%
  mutate(pie_class = if_else(max_percent > 1, class, "other"))

conditions <- unique(pull(tidy_data, condition))

mean_log2_class <- tidy_data %>%
  dplyr::group_by(class, condition) %>%#, sample_name) %>%
  dplyr::summarise(
    mean = mean(log2_value),
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = condition, values_from = mean) %>%
  mutate(ratio = .data[[levels(conditions)[2]]] - .data[[levels(conditions)[1]]])
  #mutate(ratio = .data[[exp_conditions[1]]] - .data[[exp_conditions[2]]])
```

```{r}
t_test_by_class <- tidy_data %>%
  group_by(class) %>%#, condition, sample_name) %>%
  select(class, sample_name, condition, log2_value) %>%
  rstatix::t_test(log2_value ~ condition, paired = params$paired) %>%
  ungroup() %>%
  mutate(padj = p.adjust(p, method="BH")) %>%
  ungroup() %>%
  mutate(tadj = qt(padj/2, df)) %>%
  left_join(mean_log2_class) %>%
  mutate(SE = abs(ratio/tadj), lower.limit=ratio-1.96*SE, upper.limit=ratio+1.96*SE) 

```

<hr class="style2">  

### Summary of total amounts across all samples

The pie charts show the proportion of lipid types in the samples. Any that comprised
< 1% of the total amount were grouped into an "other" category for the pie charts.
The full set and values can be found in the table below.  
The plots and table show total summed values across all replicates.

```{r, pie_charts, out.width=c('50%', '50%'), fig.show='hold', fig.height = 7}
pie_data <- totals %>%
  select(pie_class, percent, condition) %>%
  group_by(pie_class, condition) %>%
  summarise(total_pie_percent = sum(percent)) %>%
  ungroup()

plot_base_pie <- function(pie_condition){
  
  pie_condition_data <- pie_data %>%
    filter(condition == pie_condition)
  
  pie(
    pie_condition_data$total_pie_percent, 
    labels = pie_condition_data$pie_class, 
    col    = rainbow(nrow(pie_condition_data)),
    main   = pie_condition
  )
}

purrr::walk(levels(pie_data$condition), plot_base_pie)

```

### Total amounts
```{r}
totals_table <- totals %>%
  select(class, condition, total) %>%
  left_join(total_of_means) %>%
  dplyr::arrange(desc(max_percent)) %>%
  select(class, condition, total, mean_total, percent) %>%
  tidyr::pivot_wider(names_from = condition, values_from = c(total, mean_total, percent))

totals_table %>%
  DT::datatable(
      rownames = FALSE, 
      options = list(pageLength = 10, dom = "tlip"), 
     # filter = list(position = "top"),
      escape = FALSE
      ) %>%
    DT::formatRound(digits = 2, 2:7) 
```

```{r}
out_file <- paste0(params$output_folder, "/totals_table.csv") 
readr::write_csv(totals_table, file = out_file) 
```


<br><br>
<hr>
<br><br>

### Total amounts - linear scale

Bar shows median value per class.

T-tests were performed on log transformed data. Bars are annotated with a star if there was a significant difference between the conditions (adjusted p-value < 0.05). 

```{r barplot_totals_median}
pvals_by_class <- select(t_test_by_class, class, padj)

bar_data_totals <- bar_data_totals %>%
  left_join(superclasses) %>%
  mutate(max_super_value = max(max_median)) %>%
  left_join(pvals_by_class) %>%
  mutate(bar_label = if_else(padj < 0.05, "*", "")) 

bar_data_totals %>%  
    ggplot(aes(x = class, y = value, fill = condition)) +
    geom_bar(aes(y = median), 
           colour = "black", 
           position= position_dodge(width = dodge_width),
           width = 0.8,
           stat="identity",
           lwd = 0.8) + 
    geom_text(aes(y = max_median), 
            nudge_y = bar_data_totals$max_super_value*0.05, 
            label = bar_data_totals$bar_label,
            size = 6,
            col = "red") +
    #geom_point(aes(color = condition), position= position_dodge(width = dodge_width)) +
    geom_point(shape = 21, position= position_dodge(width = dodge_width)) +
    scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
   # scale_color_manual(values = c("#9ac4d6", "#f7f7c3")) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, face = "bold")) +
    xlab("") +
    ylab(params$bar_class_ylabel) +
    facet_wrap(~ superclass, scales = "free")

```


### Mean of total amounts - linear scale
  
These bar plots may be misleading if the data is not normally distributed.

T-tests were performed on log transformed data. Bars are annotated with a star if there was a significant difference between the conditions (adjusted p-value < 0.05). 

```{r, bar_totals_processing}
pvals_by_class <- select(t_test_by_class, class, padj)
  
bar_total_data <- total_of_means %>%
  left_join(superclasses) %>%
  group_by(superclass) %>%
  mutate(max_super_value = max(mean_total)) %>%
  ungroup() %>%
  select(superclass, class, condition, mean_total, se_total, max_mean_total, max_super_value) %>%
  left_join(pvals_by_class) %>%
  mutate(bar_label = if_else(padj < 0.05, "*", ""))
```

```{r, bar_totals, fig.width = 10, fig.height=8}
bar_total_data %>%
  ggplot(aes(x = class, y = mean_total, fill = condition)) + 
  geom_bar(
    colour = "black", 
    position= position_dodge(width = 0.8),
    width = 0.8,
    stat="identity",
    lwd = 0.8
  ) + 
  geom_errorbar(
      aes(ymin=mean_total-se_total, ymax=mean_total+se_total), 
      position = position_dodge(width = dodge_width), 
      width = 0.25,
      lwd = 0.8
    ) +
  geom_text(aes(y = max_mean_total), 
            nudge_y = bar_total_data$max_super_value*0.05, 
            label = bar_total_data$bar_label,
            size = 6) +
  scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, face = "bold")) +
  xlab("") +
  facet_wrap(~ superclass, scales = "free")
```

<br>
<hr>
<br>

### Total amounts - log2 scale

```{r, boxplot_totals, fig.width = 10, fig.height=8}
tidy_data %>%
  left_join(superclasses) %>%
    ggplot(aes(x = class, y = log2_value, fill = condition)) + 
    geom_violin(
      position= position_dodge(width = 0.9),
      width = 0.8,
      lwd = 0.8,
      draw_quantiles = c(0.25, 0.5, 0.75)
    ) +
    scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
    geom_point(position = position_dodge(width = 0.9), alpha = 0.8, shape = 21) +
    #geom_boxplot(width=0.2, position = position_dodge(width = 0.9), alpha = 0.1) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, face = "bold")) +
    facet_wrap(~ superclass, scales = "free")
```


```{r, boxplot_totals, fig.width = 10, fig.height=8}
tidy_data %>%
  left_join(superclasses) %>%
    ggplot(aes(x = class, y = log2_value, fill = condition)) + 
    stat_boxplot(
     # colour = "black"#, 
      position= position_dodge(width = 0.9),
      width = 0.6,
      lwd = 0.8
    ) + 
    scale_fill_manual(values = c("#9ac4d6", "#f7f7c3")) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, face = "bold")) +
    facet_wrap(~ superclass, scales = "free")
```


```{r forest_class, fig.width = 10, fig.height=8}
t_test_by_class %>%
  left_join(superclasses) %>%
  ggplot(aes(ratio, class)) +
    geom_errorbar(aes(xmin=lower.limit, xmax=upper.limit), width = 0.5, lwd=0.8, show.legend=FALSE)+
    geom_point(size=3, colour="darkred")+
    geom_vline(xintercept=0, linetype="dashed", color = "red")+
    scale_x_continuous(breaks=seq(from =-15, by=1, to=5)) +
    facet_wrap(~ superclass, scales = "free")
```


```{r, results="asis"}
# doesn't work properly using headers as it messes up the tabs
large_text <- function(x, size = 16) {
  sprintf("<span style='font-size: %spx;'>%s</span>", size, x)
}
```

```{r, heatmap_processing}
var_above0 <- all_data %>%
  pivot_longer(-lipid_name) %>%
  group_by(lipid_name) %>%
  summarise(variance = var(value)) %>%
  filter(variance > 0) %>%
  select(lipid_name) %>%
  left_join(all_data)

heatmap_data <- tibble::column_to_rownames(var_above0, "lipid_name")
```  

```{r, heatmap_processing2}
# rearrange matrix so control samples come first
samples_conditions <- enframe(colnames(heatmap_data), name = NULL, value = "sample_name") %>%
  left_join(meta_type) 

control_samples <- samples_conditions %>%
  filter(condition == params$control) %>%
  pull(sample_name)

heatmap_data <- relocate(heatmap_data, control_samples)

col_annotation <- samples_conditions %>%
  tibble::column_to_rownames("sample_name") %>%
  arrange(condition)
  
#---------------------------------------------

classes <- tidy_data %>%
  select(lipid_name, class) %>%
  distinct()

# row names with their class
df_lipids <- var_above0 %>%
  select(lipid_name) %>%
  left_join(classes) 

row_annotation <- tibble::column_to_rownames(df_lipids, "lipid_name")

# Lipid classes need further sorting to create custom row annotations where only
# the class name is displayed rather than each individual lipid.
lipid_summary <- get_lipid_summary(df_lipids)
lipid_labels <- create_lipid_class_labels(lipid_summary, nrow(df_lipids))
lipid_colours <- create_lipid_colours(
  class_names = dplyr::pull(lipid_summary, class)
)
group_colours <- stats::setNames(c("blue", "darkgreen"), levels(col_annotation$condition))

annot_colours <- list(
  condition = group_colours,
  class = lipid_colours
)
```

<br>
<br>
<hr class="style2">  
<br>
<br>  
  
###  Volcano plot

<div class = "row">
<div class = "col-md-4">
<br><br>
The y axis shows the –log10(padj); that is the negative of the log-transformed p-values, 
adjusted for multiple comparisons.  
The x axis shows the magnitude of difference between the conditions for that lipid, 
expressed as a ratio.  
Any points to the right of the grey dashed line have higher values in `r exp_conditions[1]` compared to `r exp_conditions[2]`, and vice versa for points left of the grey line.  

Each point on the plot is a lipid subclass.   
Hover over a point to see the name.

The dashed red line shows significance (adj p<0.05) i.e. any points above it represent 
a significant difference between the 2 conditions.


</div>
<div class = "col-md-8">
```{r, volcano, fig.height=5, fig.width=6}
p <- t_test_res %>%
  left_join(superclasses) %>%
  ggplot(aes(x = ratio, y = -log10(padj), col = superclass, annotation = lipid_name)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05), col = "red", linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed", col = "grey") +
  theme(legend.title = element_blank())

plotly::ggplotly(p, tooltip = "lipid_name")
```
</div>
</div>

<br>
<br>
<hr class="style2">  
<br>
<br>

### Heatmaps

#### Lipids that change between conditions, with row clustering and column clustering  
  
Row labels are shown if there are < 70 rows. 

```{r, heatmap1, fig.height = 8, fig.width = 10, results = "asis"}
sig_lipids <- t_test_res %>%
  filter(padj < 0.05) %>%
  pull(lipid_name)

if(length(sig_lipids) >= 2){
  
  heatmap_sig <- heatmap_data[sig_lipids,]
  row_annot_sig <- row_annotation[sig_lipids,]
  too_many_names <- if_else(nrow(heatmap_sig) > 70, FALSE, TRUE)
  
  heatmap0 <- pheatmap::pheatmap(
    heatmap_sig,
    scale = "row",
    annotation_row = row_annotation,
    annotation_col = col_annotation,
    annotation_colors = annot_colours, 
    show_rownames = too_many_names
  )
  
  heatmap0
} else cat("Not enough significant lipids to plot a heatmap")
```



#### All lipids, rows ordered by lipid subclass, columns ordered by condition, no clustering

```{r, heatmap1, fig.height = 8, fig.width = 10}
heatmap1 <- pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  labels_row = lipid_labels,
  fontsize_row = 8,
  annotation_colors = annot_colours#,
  #annotation_legend = FALSE
)

heatmap1
```

<br>
<br>

#### All lipids, rows ordered by lipid subclass, clustered by columns

```{r, heatmap2, fig.height = 8, fig.width = 10}
heatmap2 <- pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  cluster_rows = FALSE,
  labels_row = lipid_labels,
  fontsize_row = 8,
  annotation_colors = annot_colours#,
  #annotation_legend = FALSE
)

heatmap2

```

<br>
<br>

#### All lipids, with row clustering and column clustering

```{r, heatmap3, fig.height = 8, fig.width = 10}
too_many_names <- if_else(nrow(heatmap_data) > 70, FALSE, TRUE)

heatmap3 <- pheatmap::pheatmap(
  heatmap_data,
  scale = "row",
  annotation_row = row_annotation,
  annotation_col = col_annotation,
  annotation_colors = annot_colours, 
  show_rownames = too_many_names
)

heatmap3

```

